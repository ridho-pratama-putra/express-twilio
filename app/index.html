<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><!DOCTYPE html>
        <html>
        <head>
        <meta charset="utf-8" />
        <title>Twilio Video Demo</title>
    <!-- Twilio Video CDN -->
    <script src="https://sdk.twilio.com/js/video/releases/2.15.2/twilio-video.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>

    <script type="application/javascript">
        $(document).ready(function () {
            const form = document.getElementById("room-name-form");
            const joinForm = document.getElementById("join-room-form");
            const roomNameInput = document.getElementById("room-name-input");
            const tokenRoom = document.getElementById("room-token-input");
            const container = document.getElementById("video-container");
            console.log('ready to go')
            const startRoom = async (event) => {
                console.log('start room')
                // prevent a page reload when a user submits the form
                event.preventDefault();
                // hide the join form
                form.style.visibility = "hidden";
                // retrieve the room name
                const roomName = roomNameInput.value;

                // fetch an Access Token from the join-room route
                const response = await fetch("/join-room", {
                    method: "POST", headers: {
                        Accept: "application/json", "Content-Type": "application/json",
                    }, body: JSON.stringify({roomName: roomName}),
                });
                const {token} = await response.json();

                // join the video room with the token
                const room = await joinVideoRoom(roomName, token);

                // render the local and remote participants' video and audio tracks
                handleConnectedParticipant(room.localParticipant);
                room.participants.forEach(handleConnectedParticipant);
                room.on("participantConnected", handleConnectedParticipant);

                // handle cleanup when a participant disconnects
                room.on("participantDisconnected", handleDisconnectedParticipant);
                window.addEventListener("pagehide", () => {
                    console.log('disconnected');
                    room.disconnect();
                });
                window.addEventListener("beforeunload", () => {
                    console.log('disconnected');
                    room.disconnect();
                });
            };
            form.addEventListener("submit", startRoom);

            const handleConnectedParticipant = (participant) => {
                // create a div for this participant's tracks
                const participantDiv = document.createElement("div");
                participantDiv.setAttribute("id", participant.identity);
                container.appendChild(participantDiv);

                // iterate through the participant's published tracks and
                // call `handleTrackPublication` on them
                participant.tracks.forEach((trackPublication) => {
                    handleTrackPublication(trackPublication, participant);
                });

                // listen for any new track publications
                participant.on("trackPublished", handleTrackPublication);
            };

            const joinVideoRoom = async (roomName, token) => {
                // join the video room with the Access Token and the given room name
                const room = await Twilio.Video.connect(token, {
                    room: roomName,
                });
                return room;
            };

            const handleTrackPublication = (trackPublication, participant) => {
                function displayTrack(track) {
                    // append this track to the participant's div and render it on the page
                    const participantDiv = document.getElementById(participant.identity);
                    // track.attach creates an HTMLVideoElement or HTMLAudioElement
                    // (depending on the type of track) and adds the video or audio stream
                    participantDiv.append(track.attach());
                }

                // check if the trackPublication contains a `track` attribute. If it does,
                // we are subscribed to this track. If not, we are not subscribed.
                if (trackPublication.track) {
                    displayTrack(trackPublication.track);
                }

                // listen for any new subscriptions to this track publication
                trackPublication.on("subscribed", displayTrack);
            };

            const handleDisconnectedParticipant = (participant) => {
                // stop listening for this participant
                participant.removeAllListeners();
                // remove this participant's div from the page
                const participantDiv = document.getElementById(participant.identity);
                participantDiv.remove();
            };
        });
    </script>

</head>
<body>
<form id="room-name-form">
    Enter a Room Name to join: <input name="room_name" id="room-name-input"/>
    <button type="submit">Join Room</button>
</form>
<div id="video-container"></div>
</body>
</html>